<html>
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="/javascripts/AStar_memtronic.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">
    
    var corpses = [];
    
    var SoldierManager = function(){
      var self = this;
      var id = 0;
      var soldiers = [];
      var soldierHash = {};
      
      // probably needs optimising
      this.allSoldiers = function(){
        var myArray = [];
        for( i in soldierHash){
          if(soldierHash[i] != null){
            myArray.push(soldierHash[i]);
          };
        }
        return myArray;
      };
      
      this.createSoldier = function(speed, health){
        var newId = id++;
        soldier = new Soldier(startPoint, endPoint, grid, speed, health, newId);
        soldier.onReachDestination(function(){
          soldierHash[newId] = null;
          lives--;
          $('#lives').text(lives);
        })
        soldier.onDie(function(){
          soldierHash[newId] = null;
          kills++;
          $('#kills').text(kills);
        })
        soldierHash[newId] = soldier;
        return soldier;
      };
      
      

    };
    
    var TurretManager = function(){
      var self = this;
      var id = 0;
      var turretHash = {};
      
      // probably needs optimising
      this.allTurrets = function(){
        var myArray = [];
        for( i in turretHash){
          if(turretHash[i] != null){
            myArray.push(turretHash[i]);
          };
        }
        return myArray;
      };
      
      this.createTurret = function(position){
        var newId = id++;
        var myTurret = new Turret(position, newId);
        turretHash[newId] = myTurret;
        money -= TurretManager.cost;
        return myTurret;
      };
    }
    TurretManager.cost = 10;
    
    var startPoint = [3, 0];
    var	endPoint = [5, 19];
    
    var Grid = function(canvas_id, grid) {
	    var canvas = document.getElementById(canvas_id)
	    var ctx = canvas.getContext('2d'); 
	    var width = grid[0].length;
	    var height = grid.length;
	    var gridXInterval = canvas.width / width;
	    var gridYInterval = canvas.height / height;
	    var gridHeight = canvas.height;
	    var gridWidth = canvas.width;
      var highLight;
      var result = AStar(grid, startPoint, endPoint, "Manhattan");
	    
	    var draw = function(){
	      ctx.clearRect(0,0,gridWidth, gridHeight);
		    ctx.beginPath();
		    ctx.strokeStyle = '#aaa';
		    ctx.lineWidth = 1;
		    for (var i = 0; i < width; i++) {
		      ctx.moveTo(i* gridXInterval, 0);
		      ctx.lineTo(i* gridXInterval, gridHeight)
		    };
		    for (var i = 0; i < height; i++) {
		      ctx.moveTo(0, i*gridYInterval);
		      ctx.lineTo(gridWidth, i*gridYInterval);
		    };
		    ctx.stroke();
        drawCorpses();
		    drawStartAndEnd();
        drawTurrets();
        // drawPath();
        drawSoldiers();
        drawHighLight();
        drawBits();
		  };
		  
		  // called from the setinterval
		  this.public_draw = function(){
		    draw();
		  }
		  
		  var drawHighLight = function(){
		    if(highLight){
		      // check there is money
  		    if(money < TurretManager.cost){
  		      color = '255, 0, 0';
  		    } else {
  		      color = '0, 255, 0';
  		    }
          drawCircle(
            highLight[0],
            highLight[1],
            color
          );
          drawCircle(
            highLight[0],
            highLight[1],
            'rgba('+color+', 0.3)',
            5
          );
		    }
		  };
		  
		  var drawCircle = function(x, y, color, radius){
		    radius = radius ? radius : 1
		    ctx.beginPath();
		    ctx.fillStyle = color;
        ctx.arc(
          x * gridXInterval + gridXInterval / 2, 
          y * gridYInterval + gridXInterval / 2,
          radius * gridXInterval / 2,
          0,
          Math.PI*2,
          true
        );
        ctx.fill();
		  }
		  
		  var drawTurrets = function(){
        for(var i =0; i < myTurretManager.allTurrets().length; i++){
          var turret = myTurretManager.allTurrets()[i]
          drawCircle(
            turret.getPosition()[0],
            turret.getPosition()[1],
            'grey'
          );
        }
        // gonna do this in 2 loops for now - wasteful
        for(var i =0; i < myTurretManager.allTurrets().length; i++){
          var turret = myTurretManager.allTurrets()[i]
          connectTarget(turret);
        }
		  }
		  
		  var connectTarget =function(turret){
		    var soldier = turret.targettedSoldier();
		    if (soldier){
		      soldier.takeBullet(turret.getDamage());
          ctx.beginPath()
          tx = turret.getPosition()[0] * gridXInterval + gridXInterval/2
          ty = turret.getPosition()[1] * gridYInterval + gridYInterval/2
          ctx.moveTo(tx, ty )
          sx = soldier.getCurrentPosition()[0]
          sy = soldier.getCurrentPosition()[1]
          var coords = getNewCoords(tx, ty, sx, sy, 15);
          ctx.strokeStyle = 'black';
          ctx.lineWidth = 2;          
          ctx.lineTo(coords[0], coords[1]);
          ctx.stroke()
          ctx.beginPath()
          radius = (soldierCountDown % 2 == 0) ? 1 : 5
          // flame
  		    ctx.fillStyle = 'orange';
          ctx.arc(
            coords[0], 
            coords[1],
            radius,
            0,
            Math.PI*2,
            true
          );
          ctx.fill();
        }
		  }
		  
		  var getNewCoords = function(x1, y1, x2, y2, radius){
		    var dx = x2 - x1;
        var dy = y2 - y1;
		    var theta = Math.atan2(dy, dx);
        return [
          x1 + (Math.cos(theta) * radius),
          y1 + (Math.sin(theta) * radius)
        ]
		  }
		  
		  var drawStartAndEnd = function(){
		    ctx.fillStyle = 'yellow';
        ctx.fillRect(startPoint[0]* gridXInterval, startPoint[1]*gridYInterval, gridXInterval, gridYInterval);
        ctx.fillRect(endPoint[0]* gridXInterval, endPoint[1]*gridYInterval, gridXInterval, gridYInterval);
		  }
		  
		  var drawPath = function(){
		    for(var x, y, i = 0, j = result.length; i < j; i++) {
					x = result[i][0];
					y = result[i][1];
					ctx.fillStyle = 'blue';
			    ctx.fillRect(x* gridXInterval, y*gridYInterval, gridXInterval, gridYInterval);
				}
		  };
		  
		  var drawSoldiers = function() {
		    for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
		      drawSoldier(mySoldierManager.allSoldiers()[i]);
		    };
		  };
		  
		  var drawSoldier = function(soldier){
		    x = soldier.getCurrentPosition()[0];
				y = soldier.getCurrentPosition()[1];
				ctx.fillStyle = 'rgb(50,50,50)';
		    ctx.fillRect(
		      x - soldier.getSize()/2, 
		      y - soldier.getSize()/2, 
		      soldier.getSize(), 
		      soldier.getSize()
		    );
		    // draw the health

		    var barLength = 20
		    //background
		    ctx.fillStyle = 'red'
		    ctx.fillRect(
		      x - barLength / 2,
		      y - 15,
		      barLength,
		      5
		    )
		    ctx.fillStyle = 'rgb(0,255, 0)'
		    ctx.fillRect(
		      x - barLength / 2,
		      y - 15,
		      barLength * soldier.getHealthPercentage(),
		      5
		    )
		  }
		  
		  var drawCorpses = function() {
		    for (var i=0; i < corpses.length; i++) {
		      drawCorpse(corpses[i]);
		    };
		  };
		  
		  var drawBits = function(){
		    for (var i=0; i < bits.length; i++) {
		      var bit = bits[i]
		      if (bit == null)
		        continue
		        
		      if (bit.startTime > frameNum - 5) {
  		      bit.cX += bit.speedX
  		      bit.cY += bit.speedY
		      } else if (bit.startTime < frameNum - 100) {
	          bit = null
	          continue
	        }
		      var opacity =  1 - (frameNum - bit.startTime) / 100;
		      ctx.beginPath();
  		    ctx.fillStyle = 'rgba(255, 0, 0, '+ opacity+')';
          ctx.arc(
            bit.cX, 
            bit.cY,
            2,
            0,
            Math.PI*2,
            true
          );
          ctx.fill();
		    };
		  }
		  
		  var drawCorpse = function(corpse){
		    drawCircle(
          corpse[0],
          corpse[1],
          'rgba(255,0,0,0.1)'
        );
		  }
		  
		  this.pointCenterXY = function(x, y){
		    return [
		      x * gridXInterval + (gridXInterval/2), 
		      y * gridYInterval + (gridXInterval/2)
		    ]
		  };
		  
		  this.cellFromPosition = function(position){
		    var xIndex = Math.floor( position[0] / gridXInterval )
		    var yIndex = Math.floor( position[1] / gridYInterval )
		    return [xIndex, yIndex];
		  };
		  
		  draw();
		  
		  $(canvas).click(function(evt){
		    // check there is money
		    if(money < TurretManager.cost){
		      // no money
		      return false
		    }
		    var xIndex = Math.floor( evt.offsetX/gridXInterval )
		    var yIndex = Math.floor( evt.offsetY/gridYInterval )
		    grid[yIndex][xIndex] = 1;
		    // check the global path
		    result = AStar(grid, startPoint, endPoint, "Manhattan");
		    if (result.length == 0){ // fail to connect
		      grid[yIndex][xIndex] = 0;
  		    result = AStar(grid, startPoint, endPoint, "Manhattan");
  		    return false
		    };
		    //check for all the soldiers
		    for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
		      if (!mySoldierManager.allSoldiers()[i].regeneratePath()) {
		        grid[yIndex][xIndex] = 0;
    		    result = AStar(grid, startPoint, endPoint, "Manhattan");
		        return false;
		      }
		    };
		    highLight = null;
		    myTurretManager.createTurret([xIndex, yIndex]);
	      draw();
		  });
		  
		  $(canvas).mousemove(function(evt){
		    var xIndex = Math.floor( evt.offsetX/gridXInterval )
		    var yIndex = Math.floor( evt.offsetY/gridYInterval )
		    highLight = [xIndex, yIndex];
	    });
	    
	    $(canvas).mouseout(function(evt){
		    highLight = null;
	    });

	  };
	  
	  var Turret = function(position, id){
	    var position = position;
	    var id = id;
	    var range = 2;
	    var damage = 1;
	    var cost = 1;
	    
	    this.getPosition = function() {
	      return position;
	    };
	    
	    this.targettedSoldier = function() {
	      return soldiersInRange()[0];
	    }
	    
	    var soldiersInRange = function(){
	      myArray = [];
	      for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
	        var soldier = mySoldierManager.allSoldiers()[i];
	        if (soldier.getCurrentPoint()[0] >= position[0]-range && 
	              soldier.getCurrentPoint()[0] <= position[0]+range &&
	            soldier.getCurrentPoint()[1] >= position[1]-range && 
	              soldier.getCurrentPoint()[1] <= position[1]+range ){
	          myArray.push(soldier);
	        }
	      };
	      return myArray;
	    };
	    
	    this.getDamage = function(){
	      return damage;
	    };
	  }
	  
	  var Soldier = function(startPoint, endPoint, grid, speed, health, id){
	    var self = this;
      // this.xPos;
      // this.yPos;
      var initialHealth = health;
	    var health = initialHealth;
	    var myPath;
	    var pathIndex = 0;
	    var currentPoint;
	    var currentPosition;
	    var id;
	    var deathCallback;
	    var destinationCallback;
	    var nextPoint;
	    var nextPointPosition;
	    var speed = speed;
	    
	    this.move = function(){
	      // kludge
	      if (nextPointPosition[0] > currentPosition[0]){
	        currentPosition[0] += speed;
	      } else {
	        currentPosition[0] -= speed;
	      }
	      if (nextPointPosition[1] > currentPosition[1]){
	        currentPosition[1] += speed;
	      } else {
	        currentPosition[1] -= speed;
	      }
	      var cell = mygrid.cellFromPosition( currentPosition );
        if (nextPoint == undefined){
          destinationCallback();
          return false
        } else if ( cell[0] == nextPoint[0] && cell[1] == nextPoint[1]) {
	        pathIndex++
          if (pathIndex < myPath.length){
            currentPoint = myPath[pathIndex];
            nextPoint    = myPath[pathIndex + 1];
            if (nextPoint)
    	        nextPointPosition = mygrid.pointCenterXY(nextPoint[0], nextPoint[1]);
          } 
	      }
	    }
	    
	    this.getCurrentPosition = function(){
	      return currentPosition;
	    }
	    
	    this.regeneratePath = function(){
	      var newPath = AStar(grid, currentPoint, endPoint, "Manhattan");
		    if (newPath.length == 0){
          return false;
		    } else {
		      pathIndex = 0;
		      myPath = newPath;
		      return true;      
		    };
	    }
	    
	    // this is the grid coordinate for the soldier
	    this.getCurrentPoint = function(){
	      return currentPoint;
	    }
	    
	    this.onReachDestination = function(callback){
	      destinationCallback = callback;
	    }
	    
	    this.onDie = function(callback){
	      deathCallback = callback;
	    }
	    
	    this.getSize = function(){
	      return 10;
	    };
	    
	    this.takeBullet = function(damage) {
	      health -= damage;
	      if ( health <= 0 ){
	        corpses.push(
	          new Corpse(self.getCurrentPosition())
	        )
	        deathCallback();
	        money++;
	      }
	    }
	    
	    this.getHealthPercentage = function(){
	      return health / initialHealth;
	    }
	    
	    var initialise = function(){
	      myPath = AStar(grid, startPoint, endPoint, "Manhattan");
	      currentPoint = myPath[pathIndex];
	      nextPoint = myPath[pathIndex + 1];
	      currentPosition =   mygrid.pointCenterXY(currentPoint[0], currentPoint[1]);
	      nextPointPosition = mygrid.pointCenterXY(nextPoint[0], nextPoint[1]);
	    }
	    
	    initialise();
	  }
	  
	  var bits = [];
		var Corpse = function(position) {
		  var startPosition = position;
		  
	    var i = 5
      while (i) {
        bits.push({
          speedX: 15 - (Math.random() * 30),
          speedY: 15 - (Math.random() * 30),
          cX: position[0],
          cY: position[1],
          startTime: frameNum
        })
        i--;
      }
		};
		
		function GridGenerator(width, height){
			var	floor = Math.floor,
				random = Math.random,
				result = new Array(height);
			for(var	j, i = 0; i < height; i++) {
				result[i] = new Array(width);
				for(j = 0; j < width; j++)
					result[i][j] = 0
			};
			return result;
		};
		
		var kills = 0;
		var grid;  
		var lives = 20;
		var mySoldierManager;
		var myTurretManager;
		var mygrid;
		var regularity = 50; // the speed that new soldiers appear
		var waveLength = 10; // the length of a wave - eg how many soldiers per round
		var soldierCountDown = regularity;
		var waveCountDown = waveLength;
		var speed = 2;
		var health = 100;
		var round = 1;
		var money = 20;
		var frameNum = 0
		
	  $().ready(function(){
	    mySoldierManager = new SoldierManager();
	    myTurretManager = new TurretManager();
	    grid = GridGenerator(20, 20);
	    mygrid = new Grid('canvas', grid);
	      
	    //  global interval
	    globalInterval = setInterval(function(){
	      frameNum ++;
	      if (lives == 0){
          console.log('death to you');
          clearInterval(globalInterval);
        }
        
        if (soldierCountDown > 0){
          soldierCountDown--;
        } else {
          if (waveCountDown > 0){
            waveCountDown--;
          } else {
            round++;
            // mark the round number
            $('#round').text(round);
            waveCountDown = waveLength;
            if (round % 3 == 0)
              speed   ++;
            if (round % 3 == 1)
              health  += 20;
            if (round % 3 == 2)
              if (regularity > 5) // we don't want it too hardcore
                regularity -= 2;
          }
          // add new soldier
          mySoldierManager.createSoldier(speed, health);
          soldierCountDown = regularity;
        }
        
	      // move the soldiers
        for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
          mySoldierManager.allSoldiers()[i].move();
        };
        
        mygrid.public_draw();
        
        $('#money').text(money);
      }, 60);
      $('#canvas').dblclick(function(evt){
        clearInterval(globalInterval);
      })
	  });
  </script>
</head>
<body>
  <p>Lives: <span id="lives"></span></p>
  <p>Round: <span id="round"></span></p>
  <p>Kills: <span id="kills"></span></p>
  <p>Money: <span id="money"></span></p>
<canvas id="canvas" height="500" width="500"></canvas>
</body>
</html>