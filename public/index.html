<html>
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="javascripts/AStar_memtronic.js"></script>
  <script src="javascripts/soldier.js"></script>
  <script src="javascripts/grid.js"></script>
  <script src="javascripts/explosive.js"></script>
  <script src="javascripts/turret.js"></script>
  <script src="javascripts/units.js"></script>
  <script src="javascripts/levels.js"></script>
  <script type="text/javascript" charset="utf-8">
    
    var corpses = [];
	  
	  var bits = [];
		var Corpse = function(position) {
		  var startPosition = position;
	    var i = 5
      while (i) {
        bits.push({
          speedX: 15 - (Math.random() * 30),
          speedY: 15 - (Math.random() * 30),
          cX: position[0],
          cY: position[1],
          startTime: frameNum
        })
        i--;
      }
		};
		
		function GridGenerator(width, height){
			var	floor = Math.floor,
				random = Math.random,
				result = new Array(height);
			for(var	j, i = 0; i < height; i++) {
				result[i] = new Array(width);
				for(j = 0; j < width; j++)
					result[i][j] = 0
			};
			return result;
		};
		
		
		var kills = 0;
		var grid;  
		var lives = 20;
		var mySoldierManager;
		var myTurretManager;
		var mygrid;
		var regularity = 20; // the speed that new soldiers appear
		var waveLength = 10; // the length of a wave - eg how many soldiers per round
		var soldierCountDown = regularity;
		var waveCountDown = waveLength;
		var speed = 2;
		var health = 100;
		var round = 1;
		var money = 20;
		var frameNum = 0;
		var startPoint =  [3, 0];
    var	endPoint =    [5, 14];
    var currentTurretIndex = 0;
		var paused = false;
		var playing =  false;
		var explosions = [];
		var sounds;
		var muted = true;
		
		var incrementKills = function(bounty){			
			changeMoney(bounty);
			kills++;
      $('#kills').text(kills);
			AttemptToWinGame();
		};
		
		function changeMoney(amount){
			money += amount;
			$('#money').text(money);
			drawTurretButtons();
		}
		
		var AttemptToWinGame = function(){
		  if (round == waves.length && waveCountDown == 0 && mySoldierManager.allSoldiers().length == 0){
		    $('#notice').text('YOU WIN!')
  			clearInterval(globalInterval);
  			playing = false;
			}
		}
		
		var loseLife = function(){
		  lives--;
      $('#lives').text(lives);
		}
		

		
		var frameFunction = function(){
			sounds = {}
      frameNum ++;
      if (lives == 0){
        $('#notice').text('death to you, sucker!!! you are teh suck!!!');
        clearInterval(globalInterval);
        playing = false;
      }
      
			aimAndFireTurrets()
      
      if (soldierCountDown > 0){
        soldierCountDown--;
      } else {
        if (waveCountDown > 0){
          waveCountDown--;
        } else {
					if(round <= waves.length){
						$('#notice').text('Round ' + round + ' completed (of '+waves.length+')');
						round++;
						// mark the round number
            $('#round').text(round);
						wave = waves[round - 1];
						waveCountDown = wave[2];
						regularity = wave[1];
						typeIndex = wave[0];
					}
        }
				if (round	<= waves.length){
        	mySoldierManager.createSoldier(typeIndex);
				}
        soldierCountDown = regularity;
      }
      
      // move the soldiers
      for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
        mySoldierManager.allSoldiers()[i].move();
      };
      for(s in sounds){
				playSound(s);
			}
      mygrid.public_draw();
    }
		
	  $().ready(function(){	    
	    mySoldierManager = new SoldierManager();
	    myTurretManager = new TurretManager();
	    grid = GridGenerator(15, 15);
			//add terrain to grid
			for (var i=0; i < terrain.length; i++) {
	     grid[ terrain[i][1] ][terrain[i][0]] = 1;
	    };
	    mygrid = new Grid('canvas', grid);
	    drawTurretButtons();
	    
	    wave = waves[0];
			waveCountDown = wave[2];
			regularity = wave[1];
			typeIndex = wave[0];
			
			$('#notice').text('RELEASE THE HORDES!!!!');
			playing = true;
	    //  global interval
	    globalInterval = setInterval(frameFunction, 60);
			
			
      $('#pause_button').click(function(evt){
				if(!paused){
        	clearInterval(globalInterval);
					paused = true;
					$('#pause_button').text('Play');
				} else {
					globalInterval = setInterval(frameFunction, 60);
					paused = false;
					$('#pause_button').text('Pause');
				}
      })

      $('#mute_button').click(function(evt){
				if(!muted){
					muted = true;
				} else {
					muted = false;
				}
      })
	  });
	  
	  var drawTurretButtons = function(){
	    $('#turret_choices').text('')
	    for (var i=0; i < unitTypes.length; i++) {
	      var t = unitTypes[i];
	      var tbutton = $('<a href="#">').text(t['name'] + ' ($'+ t['cost']+')' )
	      tbutton.attr('id', 'button_'+i);
				if (i == currentTurretIndex)
					tbutton.addClass('selected');
				if (money >= t['cost']){
					tbutton.addClass('allowed');
				} else {
					tbutton.addClass('not_allowed')
				}
				(function(i){
					tbutton.click(function(){
						setCurrentUnit(i)
	 	 	    });
				})(i);
  	    $('#turret_choices').append(tbutton);
	    };
	  }
	
		var setCurrentUnit = function(i){
			currentTurretIndex = i;
			$('.selected').removeClass('selected');
			$('#button_'+ i).addClass('selected');
		}
		var aimAndFireTurrets = function(){
			// aim the turrets and fire if possible
      for(var i =0; i < turrets.length; i++){
        turrets[i].aimAndFire();
      }
		}
    
    playSound = function(id) {
			if(!muted){
      	x = $('#'+ id).clone();
      	x[0].play();
			}
    }
  </script>
<style type="text/css" media="screen">
	* {
		font-family: arial;
	}
	a {
	  color: black;
		text-decoration: none;
	}
	#notice {
		font-size: 2em;
		text-align: center;
		width: 400px;
		margin-left: 200px;
	}
	#turret_choices a {
    display: block;
    padding: 5px;
    float: left;
	}
	#turret_choices a:hover {
    background: yellow;
	}
	p {
	  clear: left;
	}
	.allowed {
		background: rgb(0, 255, 0);
	}
	.not_allowed {
		background: silver;
		color: gray;
	}
	.selected {
		color: yellow;
	}
</style>
</head>

<body>
	
<div id="notice">Game starting soon</div>

<div style="float:left; width: 200px">
	<p>Lives: <span id="lives"></span></p>
  <p>Round: <span id="round"></span></p>
  <p>Kills: <span id="kills"></span></p>
  <p>Money: <span id="money"></span></p>
  
  <div>
    <h3>Choose your weapons!!!</h3>
    <div id="turret_choices"></div>
		<p><a href="#" id="pause_button">Pause</a></p>
		<p><a href="#" id="mute_button">turn on sound fx</a></p>
  </div>
</div>
<canvas id="canvas" height="400" width="400"></canvas>

<audio class='hidden' id="sweet"> 
  <source src='audio/K.mp3' /> 
</audio>
<audio class='hidden' id="shot"> 
  <source src='audio/gun_shotgun2.mp3' /> 
</audio>
</body>
</html>