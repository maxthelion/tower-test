<html>
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="javascripts/AStar_memtronic.js"></script>
  <script src="javascripts/soldier.js"></script>
  <script src="javascripts/grid.js"></script>
  <script src="javascripts/turret.js"></script>
  <script type="text/javascript" charset="utf-8">
    
    var corpses = [];
	  
	  var bits = [];
		var Corpse = function(position) {
		  var startPosition = position;
		  
	    var i = 5
      while (i) {
        bits.push({
          speedX: 15 - (Math.random() * 30),
          speedY: 15 - (Math.random() * 30),
          cX: position[0],
          cY: position[1],
          startTime: frameNum
        })
        i--;
      }
		};
		
		function GridGenerator(width, height){
			var	floor = Math.floor,
				random = Math.random,
				result = new Array(height);
			for(var	j, i = 0; i < height; i++) {
				result[i] = new Array(width);
				for(j = 0; j < width; j++)
					result[i][j] = 0
			};
			return result;
		};
		
		var kills = 0;
		var grid;  
		var lives = 20;
		var mySoldierManager;
		var myTurretManager;
		var mygrid;
		var regularity = 20; // the speed that new soldiers appear
		var waveLength = 10; // the length of a wave - eg how many soldiers per round
		var soldierCountDown = regularity;
		var waveCountDown = waveLength;
		var speed = 2;
		var health = 100;
		var round = 1;
		var money = 20;
		var frameNum = 0;
		var startPoint =  [3, 0];
    var	endPoint =    [5, 14];
    var currentTurretIndex = 0;
		var nuking = false;
		var paused = false;
		var playing =  false;
		var nukeRadius = 5;
		
		var incrementKills = function(bounty){			
			money += bounty;
			kills++;
      $('#kills').text(kills);
			AttemptToWinGame();
		};
		
		var AttemptToWinGame = function(){
		  if (round == waves.length && waveCountDown == 0 && mySoldierManager.allSoldiers().length == 0){
		    $('#notice').text('YOU WIN!')
  			clearInterval(globalInterval);
  			playing = false;
			}
		}
		
		var loseLife = function(){
		  lives--;
      $('#lives').text(lives);
		}
		
		// wave looks like [soldierType, regularity, wavelength]
		var waves = [
			[0, 30, 10],
			[0, 30, 10],
			[1, 15, 10],
			[1, 15, 10],
			[1, 30, 5],
			[0, 5, 10],
			[1, 50, 5],
			[0, 5, 10],
			[2, 10, 5],
			[0, 15, 5],
			[0, 15, 10],
			[1, 10, 10]
		];
		
		var k = 10;
		var terrain = [];
		while(k > 0){
		 terrain.push( [Math.floor(Math.random() * 15), Math.floor(Math.random() * 15)] );
		 k--
		}
		
		var frameFunction = function(){
      frameNum ++;
      if (lives == 0){
        $('#notice').text('death to you, sucker!!! you are teh suck!!!');
        clearInterval(globalInterval);
        playing = false;
      }
      
      // aim the turrets and fire if possible
      for(var i =0; i < myTurretManager.allTurrets().length; i++){
        var turret = myTurretManager.allTurrets()[i]
        turret.aimAndFire();
      }
      
      if (soldierCountDown > 0){
        soldierCountDown--;
      } else {
        if (waveCountDown > 0){
          waveCountDown--;
        } else {
					if(round <= waves.length){
						$('#notice').text('Round ' + round + ' completed (of '+waves.length+')');
						round++;
						// mark the round number
            $('#round').text(round);
						wave = waves[round - 1];
						waveCountDown = wave[2];
						regularity = wave[1];
						typeIndex = wave[0];
					}
        }
				if (round	<= waves.length){
        	mySoldierManager.createSoldier(typeIndex);
				}
        soldierCountDown = regularity;
      }
      
      // move the soldiers
      for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
        mySoldierManager.allSoldiers()[i].move();
      };
      
      mygrid.public_draw();
      
      $('#money').text(money);
    }
		
	  $().ready(function(){	    
	    mySoldierManager = new SoldierManager();
	    myTurretManager = new TurretManager();
	    grid = GridGenerator(15, 15);
	    for (var i=0; i < terrain.length; i++) {
	     grid[ terrain[i][1] ][terrain[i][0]] = 1;
	    };
	    mygrid = new Grid('canvas', grid);
	    drawTurretButtons();
	    
	    wave = waves[0];
			waveCountDown = wave[2];
			regularity = wave[1];
			typeIndex = wave[0];
			
			$('#notice').text('RELEASE THE HORDES!!!!');
			playing = true;
	    //  global interval
	    globalInterval = setInterval(frameFunction, 60);
			
			
      $('#pause_button').click(function(evt){
				if(!paused){
        	clearInterval(globalInterval);
					paused = true;
					$('#pause_button').text('Play');
				} else {
					globalInterval = setInterval(frameFunction, 60);
					paused = false;
					$('#pause_button').text('Pause');
				}
      })
	  });
	  
	  var drawTurretButtons = function(){
	    $('#turret_choices').text('')
	    for (var i=0; i < myTurretManager.getTurretTypes().length; i++) {
	      var t = myTurretManager.getTurretTypes()[i];
	      var tbutton = $('<a href="#">').text(myTurretManager.getTurretTypes()[i]['name'])
	      tbutton.data('foo', i)
	      tbutton.click(function(){
	        currentTurretIndex = $(this).data('foo');
 	 	    });
  	    $('#turret_choices').append(tbutton);
	    };
	  }
	  
	  $(window).keydown(function(event) {
      if (event.keyCode == '78') {
         nuking = true;
       }
    });
    
    $(window).keyup(function(event) {
      if (event.keyCode == '78') {
         nuking = false;
       }
    });
    
    playSound = function(id) {
      x = $('#'+ id).clone();
      x[0].play();
    }
  </script>
<style type="text/css" media="screen">
	* {
		font-family: arial;
	}
	a {
	  color: black;
	}
	#notice {
		font-size: 2em;
		text-align: center;
		width: 400px;
		margin-left: 200px;
	}
	#turret_choices a {
    display: block;
    padding: 5px;
    float: left;
	}
	#turret_choices a:hover {
    background: yellow;
	}
	p {
	  clear: left;
	}
</style>
</head>

<body>
	
<div id="notice">Game starting soon</div>

<div style="float:left; width: 200px">
	<p>Lives: <span id="lives"></span></p>
  <p>Round: <span id="round"></span></p>
  <p>Kills: <span id="kills"></span></p>
  <p>Money: <span id="money"></span></p>
  
  <div>
    <h3>Choose your weapons!!!</h3>
    <div id="turret_choices"></div>
		<p><a href="#" id="pause_button">Pause</a></p>
  </div>
</div>
<canvas id="canvas" height="400" width="400"></canvas>

<audio class='hidden' id="sweet"> 
  <source src='audio/K.mp3' /> 
</audio>
<audio class='hidden' id="shot"> 
  <source src='audio/gun_shotgun2.mp3' /> 
</audio>
</body>
</html>