<html>
<head>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="AStar_memtronic.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">
    
    var SoldierManager = function(){
      var self = this;
      var id = 0;
      var soldiers = [];
      var soldierHash = {};
      
      // probably needs optimising
      this.allSoldiers = function(){
        var myArray = [];
        for( i in soldierHash){
          if(soldierHash[i] != null){
            myArray.push(soldierHash[i]);
          };
        }
        return myArray;
      };
      
      this.createSoldier = function(){
        var newId = id++;
        soldier = new Soldier(startPoint, endPoint, grid, newId);
        soldier.onDie(function(){
          soldierHash[newId] = null;
          lives--;
          $('#lives').text(lives);
          if (lives == 0){
            console.log('the end');
            clearInterval(myInterval);
          }
        })
        soldierHash[newId] = soldier;
        return soldier;
      };
      
      
      myInterval = setInterval(function(){
        self.createSoldier();
      }, 1000);
    };
    
    var TurretManager = function(){
      var self = this;
      var id = 0;
      var turretHash = {};
      
      // probably needs optimising
      this.allTurrets = function(){
        var myArray = [];
        for( i in turretHash){
          if(turretHash[i] != null){
            myArray.push(turretHash[i]);
          };
        }
        return myArray;
      };
      
      this.createTurret = function(position){
        var newId = id++;
        var myTurret = new Turret(position, newId);
        turretHash[newId] = myTurret;
        return myTurret;
      };
    }
    
    var startPoint = [3, 0];
    var	endPoint = [5, 19];
    
    var Grid = function(canvas_id, grid) {
	    var canvas = document.getElementById(canvas_id)
	    var ctx = canvas.getContext('2d'); 
	    var width = grid[0].length;
	    var height = grid.length;
	    var gridXInterval = canvas.width / width;
	    var gridYInterval = canvas.height / height;
	    var gridHeight = canvas.height;
	    var gridWidth = canvas.width;
      
      var result = AStar(grid, startPoint, endPoint, "Manhattan");
	    
	    var draw = function(){
	      ctx.clearRect(0,0,gridWidth, gridHeight);
		    ctx.beginPath();
		    for (var i = 0; i < width; i++) {
		      ctx.moveTo(i* gridXInterval, 0);
		      ctx.lineTo(i* gridXInterval, gridHeight)
		    };
		    for (var i = 0; i < height; i++) {
		      ctx.moveTo(0, i*gridYInterval);
		      ctx.lineTo(gridWidth, i*gridYInterval);
		    };
		    ctx.stroke();
		    drawStart();
        drawTurrets();
        // drawPath();
        drawSoldiers();
		  }
		  
		  var drawTurrets = function(){
        for(var i =0; i < myTurretManager.allTurrets().length; i++){
          var turret = myTurretManager.allTurrets()[i]
          ctx.fillStyle = 'red';
          ctx.fillRect(
            turret.getPosition()[0] * gridXInterval, 
            turret.getPosition()[1] * gridYInterval, 
            gridXInterval, 
            gridYInterval
          );
          ctx.beginPath()
          ctx.moveTo(
            turret.getPosition()[0] * gridXInterval + gridXInterval/2, 
            turret.getPosition()[1] * gridYInterval + gridYInterval/2
          )

          ctx.lineTo(
            turret.targettedSoldier().getCurrentPoint()[0] * gridXInterval + gridXInterval/2, 
            turret.targettedSoldier().getCurrentPoint()[1] * gridYInterval + gridYInterval/2
          )
          ctx.stroke()
        }
		  }
		  
		  var drawStart = function(){
		    ctx.fillStyle = 'yellow';
        ctx.fillRect(startPoint[0]* gridXInterval, startPoint[1]*gridYInterval, gridXInterval, gridYInterval);
		  }
		  
		  var drawPath = function(){
		    for(var x, y, i = 0, j = result.length; i < j; i++) {
					x = result[i][0];
					y = result[i][1];
					ctx.fillStyle = 'blue';
			    ctx.fillRect(x* gridXInterval, y*gridYInterval, gridXInterval, gridYInterval);
				}
		  };
		  
		  var drawSoldiers = function() {
		    for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
		      drawSoldier(mySoldierManager.allSoldiers()[i]);
		    };
		  };
		  
		  var drawSoldier = function(soldier){
		    x = soldier.getCurrentPoint()[0];
				y = soldier.getCurrentPoint()[1];
				ctx.fillStyle = 'yellow';
		    ctx.fillRect(x* gridXInterval, y*gridYInterval, gridXInterval, gridYInterval);
		  }
		  
		  draw();
		  
		  $(canvas).click(function(evt){
		    xIndex = Math.floor( evt.offsetX/gridXInterval )
		    yIndex = Math.floor( evt.offsetY/gridYInterval )
		    grid[yIndex][xIndex] = 1;
		    // check the global path
		    result = AStar(grid, startPoint, endPoint, "Manhattan");
		    if (result.length == 0){ // fail to connect
		      grid[yIndex][xIndex] = 0;
  		    result = AStar(grid, startPoint, endPoint, "Manhattan");
		    };
		    //check for all the soldiers
		    for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
		      if (!mySoldierManager.allSoldiers()[i].regeneratePath()) {
		        grid[yIndex][xIndex] = 0;
    		    result = AStar(grid, startPoint, endPoint, "Manhattan");
		        return false;
		      }
		    };
		    
		    myTurretManager.createTurret([xIndex, yIndex]);
	      draw();
		  });
		  
      setInterval(function(){
        for (var i=0; i < mySoldierManager.allSoldiers().length; i++) {
          mySoldierManager.allSoldiers()[i].move();
        };
        draw();
      }, 500);

	  };
	  
	  var Turret = function(position, id){
	    var position = position;
	    var id = id;
	    
	    this.getPosition = function() {
	      return position;
	    };
	    
	    this.targettedSoldier = function() {
	      return mySoldierManager.allSoldiers()[0];
	    }
	  }
	  
	  var Soldier = function(startPoint, endPoint, grid, id){
	    var self = this;
      // this.xPos;
      // this.yPos;
	    var health;
	    var myPath;
	    var pathIndex = 0;
	    var currentPoint;
	    var id;
	    var deathCallback;
	    
	    this.move = function(){
	      pathIndex++
	      if (pathIndex < myPath.length){
	        currentPoint = myPath[pathIndex];
	      } else {
	        deathCallback();
	      }
	    }
	    
	    this.regeneratePath = function(){
	      var newPath = AStar(grid, currentPoint, endPoint, "Manhattan");
		    if (newPath.length == 0){
          return false;
		    } else {
		      pathIndex = 0;
		      myPath = newPath;
		      return true;      
		    };
	    }
	    
	    this.getCurrentPoint = function(){
	      return currentPoint;
	    }
	    
	    this.onDie = function(callback){
	      deathCallback = callback;
	    }
	    
	    var initialise = function(){
	      myPath = AStar(grid, startPoint, endPoint, "Manhattan");
	      currentPoint = myPath[pathIndex];
	    }
	    
	    initialise();
	  }
	  
		function GridGenerator(width, height){
			var	floor = Math.floor,
				random = Math.random,
				result = new Array(height);
			for(var	j, i = 0; i < height; i++) {
				result[i] = new Array(width);
				for(j = 0; j < width; j++)
					result[i][j] = 0 //(j * i) % 7 ? floor(random() * 200) % 2 : 0;
			};
			return result;
		};
		
		var grid;  
		var lives = 20;
		var mySoldierManager;
		var myTurretManager;
	  $().ready(function(){
	    mySoldierManager = new SoldierManager();
	    myTurretManager = new TurretManager();
	    grid = GridGenerator(20, 20);
	    var mygrid = new Grid('canvas', grid);
	  });
  </script>
</head>
<body>
  <p id="lives"></p>
  <p id="soldiers_sent"></p>
  <p id="towers_made"></p>
<canvas id="canvas" height="300" width="300"></canvas>
</body>
</html>